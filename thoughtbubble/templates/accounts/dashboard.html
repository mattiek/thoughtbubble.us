{% extends 'base.html' %}
{% load classnames %}
{% load getdict %}
{% load widget_tweaks %}
{% load ideacountables %}

{% load socialaccount %}


{% load avatar_tags %}

{% block title %}
    Dashboard
{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/user/dashboard.css" />
{% endblock %}

{% block bodyid %}home{% endblock %}

{% block primarynav %}
{% endblock %}

{% block content %}
    {% get_social_accounts user as accounts %}
    <div id="form-wrapper">
{#        <form action="{% url 'user_dashboard' %}" method="POST">#}
{#            {% csrf_token %}#}
        <div id="picture">
            {% avatar user %}
            <a href="#update-avatar-overlay">update</a>
{#                        <img src="{{ user.get_profile_picture }}" alt=""/>#}
        </div>
        <div id="user">
            <a id="edit-button" class="buttonize orange" href="">edit</a>
            <a id="save-button" class="buttonize orange" href="">save</a>
            <a id="cancel-button" class="buttonize blue" href="">cancel</a>
            <div class="user-info">
                {{profile.first_name|default:"first"}} {{profile.last_name|default:"last"}} | {{profile.location|default:"unknown"}}
            </div>
            <form id="update-info" action="" METHOD="POST">
                {% csrf_token %}
                {{ update_form.as_p }}
{#                {{ update_form.first_name }} {{ update_form.last_name }} {{ update_form.location }}#}
            </form>

            <div class="user-stats">
                <span class="emphasis">{{ user|idea_count }}</span> ideas
                <span class="emphasis">{{ user|idea_support_count }}</span> ideas supported
                <span class="emphasis">{{ user|communities_joined_count }}</span> communities joined
            </div>
        </div>

        <form class="uniForm" method="post">
            {% csrf_token %}

            <fieldset class="blockLabels">
                {% if form.non_field_errors %}
                    <div id="errorMsg">{{form.non_field_errors}}</div>
                {% endif %}

                {% for base_account in form.accounts %}
                    {% with base_account.get_provider_account as account %}
                        <div class="ctrlHolder">
                            <label for="id_account_{{base_account.id}}">
                                <input id="id_account_{{base_account.id}}" type="radio" name="account" value="{{base_account.id}}"/>
                                <span class="socialaccount_provider {{base_account.provider}} {{account.get_brand.id}}">{{account.get_brand.name}}</span>
                                {{account}}
                            </label>
                        </div>
                    {% endwith %}
                {% endfor %}

                <div class="buttonHolder">
                    <button type="submit">remove</button>
                </div>

            </fieldset>

        </form>

        <h2>Add a 3rd Party Account</h2>

        <ul class="socialaccount_providers">
        {% with process='connect' %}
            {% for provider in socialaccount.providers %}
                {% if provider.id == "openid" %}
                    {% for brand in provider.get_brands %}
                        <li>
                            <a title="{{brand.name}}"
                               class="socialaccount_provider {{provider.id}} {{brand.id}}"
                               href="{% provider_login_url provider.id openid=brand.openid_url process=process %}"
                                    >{{brand.name}}</a>
                        </li>
                    {% endfor %}
                {% endif %}
                <li>
                    <a title="{{provider.name}}" class="socialaccount_provider {{provider.id}}"
                       href="{% provider_login_url provider.id process=process %}">{{provider.name}}</a>
                </li>
            {% endfor %}
        {% endwith %}
        </ul>

{#                            {% include "socialaccount/snippets/login_extra.html" %}#}

        {{ form.about }}
        {{ form.news }}

{#            <input type="submit" class="submit" value="post"/>#}
{#        </form>#}
</div>

{% for idea in ideas %}
    {% include 'idea/idea_for_list.html' %}
{% endfor %}

<div id="update-avatar-overlay" class="white-popup mfp-hide">
    <p>Your current avatar: </p>
    {% avatar user %}
    {% if not avatars %}
        <p>You haven't uploaded an avatar yet. Please upload one now.</p>
    {% else %}
        <form method="POST" action="{% url 'avatar_change' %}">
            <ul>
                {{ primary_avatar_form.as_ul }}
            </ul>
            <p>{% csrf_token %}<input type="submit" value="Choose new Default" /></p>
        </form>
    {% endif %}
    <form enctype="multipart/form-data" method="POST" action="{% url 'avatar_add' %}">
        {{ upload_avatar_form.as_p }}
        <p>{% csrf_token %}<input type="submit" value="Upload New Image" /></p>
    </form>
</div>
{% endblock %}

{% block footerscripts %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/tb/tb-dashboard.js"></script>
{% endblock %}