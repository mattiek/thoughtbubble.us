{% extends 'base.html' %}
{% load classnames %}
{% load widget_tweaks %}
{% load threadedcomments_tags %}
{% load ideacountables %}

{% block title %}
    Idea List
{% endblock %}

{% block head %}

    <link rel="stylesheet" href="{{ STATIC_URL }}css/idea/detail.css" />
{% endblock %}

{% block bodyid %}home{% endblock %}

{% block primarynav %}
{% endblock %}

{% block content %}
    <div id="idea-wrapper">
        <span class="support-number">{{ idea.support_count }}</span> support this

        <a class="supporting orange {% if idea|is_supported_by_user:user %}activated{% endif %}" data-id="{{ idea.id }}" href="{{ idea.get_support_url }}"><span class="unsupported"><i></i>support</span><span class="supported">supported</span></a>
        <a class="dislike blue" href="#">dislike</a>

        {% include "widgets/sharing.html" %}

        <div class="">We want <b>{{ idea.name }}</b> in <b>{{ idea.where.name }}</b>, <b>{{ idea.where.city }}</b></div>
        <div class="">It's a <b>{{ idea.what_kind }}</b> for <b>{{ idea.what_for }}</b></div>
        <div class="">I imagine something like this:</div>
        <div class=""><b>{{ idea.description }}</b></div>
        <div class="">Links:
            {% for link in idea.idealink_set.all %}
                <a href="{{ link.url }}" target="_blank">{{ link.name }}</a>{% if not forloop.last %},{% endif %}
            {% endfor %}
        </div>

        <div>
            {% for picture in pictures %}
                <img src="{{ picture.img.url }}" alt=""/>
            {% endfor %}
        </div>


{#    Comments #}
        <div class="comments_wrapper" id="comments">
            {% render_comment_list for idea %}

            <div id="wrap_write_comment">
                {% render_comment_form for idea %}
            </div>
        </div>
    </div>
{% endblock %}

{% block footerscripts %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/plugins/jquery.file-input.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/tb/tb-listidea.js"></script>


{#    Comments javascript #}
    <script type="text/javascript">

        function show_reply_form(event) {
            var $this = $(this);
            var comment_id = $this.data('comment-id');

            $('#id_parent').val(comment_id);
            $('#form-comment').insertAfter($this.closest('.comment'));
            $('.submit_comment').on('click', function(e){
                e.preventDefault();
                $(e.target).parent().submit();
            });
        };

        function cancel_reply_form(event) {
            $('#id_comment').val('');
            $('#id_parent').val('');
            $('#form-comment').appendTo($('#wrap_write_comment'));
        }

        $.fn.ready(function() {
            $('.comment_reply_link').click(show_reply_form);
            $('#cancel_reply').click(cancel_reply_form);
            $('.submit_comment').on('click', function(e){
                e.preventDefault();
                $(e.target).parent().submit();
            });
        });


        $('.comment_support').on('click', function(e) {
            e.preventDefault();
            $target = $(e.target);
            while (!$target.attr('href'))
                $target = $target.parent();

            $.ajax({
                url: $target.attr('href'),
                success: function(data) {
                    if (data.status == 'removed') {
                        $target.removeClass('activated');
                        $(document.body).trigger({type: 'comment:support:count', target: $target, count: data.count});
                    } else if (data.status == 'added') {
                        $target.addClass('activated');
                        $(document.body).trigger({type: 'comment:support:count', target: $target, count: data.count});
                    } else {

                    }
                }
            })
        });

        //Subscribe to events
    $(document.body).on('idea:support:count', function(e){
       $('.support-number').html(e.count);
    });

        $(document.body).on('comment:support:count', function(e){
            $('span',e.target).html(e.count);
        });

    </script>
{% endblock %}